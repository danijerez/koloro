@page "/pokemon"
@using MudBlazor
@using koloro.Core.Models
@using koloro.Core.RestClients
@using Excubo.Blazor.Canvas
@inject HttpClient Http

<Canvas id="helper_canvas" @ref="helper_canvas" width="475" height="500" hidden />
<MudAppBar Color="Color.Tertiary" Class="menu_top">
    <MudForm @ref="form" @bind-IsValid="@success">
        <MudGrid>
            <MudItem xs="3">
                <MudTextField @bind-Value="nametofind" Label="id/name" Adornment="Adornment.Start" AdornmentIcon="@Icons.Filled.Mode" AdornmentColor="Color.Dark"></MudTextField>
            </MudItem>
            <MudItem xs="3">
                <MudTextField @bind-Value="offset" Label="offset" Adornment="Adornment.Start" AdornmentIcon="@Icons.Filled.FirstPage" AdornmentColor="Color.Dark"></MudTextField>
            </MudItem>
            <MudItem xs="3">
                <MudTextField @bind-Value="limit" Label="limit" Adornment="Adornment.Start" AdornmentIcon="@Icons.Filled.ContentCopy" AdornmentColor="Color.Dark"></MudTextField>
            </MudItem>
            <MudItem xs="3">
                <MudSlider @bind-Value="size" Min="125" Max="1000">@(size/2)x@(size/2)</MudSlider>
            </MudItem>
        </MudGrid>
    </MudForm>

    <MudSpacer></MudSpacer>
    <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Error" OnClick="@(()=>ResetForm())"></MudIconButton>
    <MudIconButton Icon="@Icons.Material.Filled.Send" Color="Color.Dark" OnClick="@(()=>SendForm())"></MudIconButton>

</MudAppBar>
<div class="grid">
    @if (!IsLoading)
    {
        <MudGrid Justify="Justify.Center">

            @foreach (var pokemon in ListPokemonData)
            {
                <MudItem>
                    <MudCard>
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@pokemon.id ♦ @pokemon.name</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Default" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <img id="@pokemon.name" class="size_pokemon" width="@size/2" height="@size/2" src=@pokemon.sprites.other.OfficialArtwork.front_default />
                        <MudCardActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Favorite" Color="Color.Default" />
                            <MudIconButton Icon="@Icons.Material.Filled.Share" Color="Color.Default" />
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }

        </MudGrid>
    }
    else
    {
        <MudProgressLinear Color="Color.Info" Value="@progress" Min="0" Max="100" />
    }
</div>

@code{

    private bool IsLoading = true;
    private List<PokemonData> ListPokemonData;
    private PokemonResponse ListNames;
    private double progress = 0;
    private Canvas helper_canvas;
    private int offset = 0;
    private int limit = 12;
    private int size = 250;
    private string nametofind = string.Empty;
    private MudForm form;
    private bool success;


    protected override async Task OnInitializedAsync()
    {
        await LoadPokemon();
        IsLoading = false;
    }

    private async Task SendForm()
    {
        await LoadPokemon();
        IsLoading = false;
    }

    private async Task ResetForm()
    {
        offset = 0;
        limit = 12;
        size = 250;
    }

    private async Task LoadPokemon()
    {
        progress = 0;
        IsLoading = true;
        ListPokemonData = new List<PokemonData>();

        if (!string.IsNullOrEmpty(nametofind))
        {
            ListPokemonData.Add(await PokeApiRestClient.PokemonDataByName(Http, nametofind));
        }
        else
        {
            var PokemonPag = await PokeApiRestClient.Pokemon(Http, offset, limit);

            foreach (var pokemon in PokemonPag.results)
            {
                ListPokemonData.Add(await PokeApiRestClient.PokemonDataByName(Http, pokemon.name));
                progress = ListPokemonData.Count * 100 / limit;
                StateHasChanged();
            }
        }

    }
}